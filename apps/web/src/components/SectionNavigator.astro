---
interface Props {
  language: 'et' | 'en';
}

const { language } = Astro.props;

// Define sections with their anchors and labels
const sections = [
  { id: 'hero', labelEt: 'Avaleht', labelEn: 'Home' },
  { id: 'category-etendused', labelEt: 'Etendused', labelEn: 'Performances' },
  { id: 'category-suurtele', labelEt: 'Suurtele', labelEn: 'For Adults', parent: 'category-etendused' },
  { id: 'category-noorele-publikule', labelEt: 'Noorele publikule', labelEn: 'For Young Audiences', parent: 'category-etendused' },
  { id: 'category-workshopid', labelEt: 'Töötoad', labelEn: 'Workshops' },
  { id: 'category-about', labelEt: 'Meist', labelEn: 'About' },
  { id: 'category-gallery', labelEt: 'Galerii', labelEn: 'Gallery' },
  { id: 'category-contact', labelEt: 'Kontakt', labelEn: 'Contact' },
];

const getLabel = (section: typeof sections[0]) => language === 'et' ? section.labelEt : section.labelEn;
---

<!-- Floating section navigator - always visible -->
<nav
  id="section-navigator"
  class="fixed top-8 left-8 z-50"
  aria-label="Section navigation"
>
  <!-- Collapsed state: circular pill with carousel -->
  <button
    id="nav-pill"
    class="nav-pill shadow-lg rounded-full transition-all duration-300 hover:shadow-xl focus:outline-none focus:ring-2 focus:ring-indigo-500 overflow-hidden flex items-center justify-center relative"
    style="width: 128px; height: 128px; min-width: 128px; min-height: 128px; background: linear-gradient(to right, transparent 0%, rgba(255, 255, 255, 0.7) 20%, rgba(255, 255, 255, 0.8) 40%, rgba(255, 255, 255, 0.8) 60%, rgba(255, 255, 255, 0.7) 80%, transparent 100%); backdrop-filter: blur(12px);"
    aria-expanded="false"
    aria-controls="nav-expanded"
  >
    <div style="height: 128px; width: 128px; min-width: 128px; min-height: 128px;" class="overflow-hidden relative">
      <div id="nav-carousel" class="flex flex-col items-center transition-transform duration-700 ease-in-out" style="transform: translateY(40px);">
        {sections.map(section => (
          <div style="width: 128px;" class="h-10 flex items-center justify-center nav-carousel-item">
            {section.id === 'hero' ? (
              <img src="/logo.svg" alt="Zuga" class="w-30 h-30 transition-all duration-700" />
            ) : (
              <span class="text-base font-semibold text-gray-900 transition-all duration-700 text-center px-2">
                {getLabel(section)}
              </span>
            )}
          </div>
        ))}
      </div>
    </div>
  </button>

  <!-- Expanded state: shows all sections -->
  <div
    id="nav-expanded"
    class="hidden absolute top-0 left-0 bg-white/95 backdrop-blur-md shadow-xl rounded-2xl px-4 py-3 min-w-[200px]"
  >
    <div class="relative flex flex-col space-y-1">
      <!-- Floating active indicator -->
      <div id="active-indicator" class="absolute left-0 w-full h-10 bg-indigo-100 rounded-lg transition-transform duration-700 ease-in-out pointer-events-none" style="transform: translateY(0px); opacity: 0;"></div>

      {sections.map(section => (
        <a
          href={`#${section.id}`}
          data-section={section.id}
          class:list={[
            'nav-section-link px-4 py-2 rounded-lg text-sm transition-colors duration-200 relative z-10',
            'hover:text-indigo-600',
            'focus:outline-none focus:ring-2 focus:ring-indigo-500',
            section.parent && 'pl-8 text-xs' // Indent subsections
          ]}
        >
          {getLabel(section)}
        </a>
      ))}
    </div>
  </div>
</nav>

<script define:vars={{ sections }}>
  // Only run on homepage
  if (window.location.pathname.match(/^\/(et|en)\/?$/)) {
    // Wait for DOM to be fully loaded
    function initNavigator() {
      const navPill = document.getElementById('nav-pill');
      const navExpanded = document.getElementById('nav-expanded');
      const navCarousel = document.getElementById('nav-carousel');

      if (!navPill || !navExpanded || !navCarousel) {
        console.warn('SectionNavigator: Required elements not found');
        return;
      }

      let isExpanded = false;
      let currentSectionIndex = -1; // Start at -1 so first detection triggers update

      // Section data passed from Astro
      const sectionList = sections;

    // Toggle expanded/collapsed state
    function toggleExpanded() {
      isExpanded = !isExpanded;
      navPill.setAttribute('aria-expanded', isExpanded.toString());

      if (isExpanded) {
        navPill.classList.add('hidden');
        navExpanded.classList.remove('hidden');
      } else {
        navPill.classList.remove('hidden');
        navExpanded.classList.add('hidden');
      }
    }

    // Update displayed section names
    function updateSectionDisplay(index) {
      currentSectionIndex = index;

      const current = sectionList[index];

      // Scroll carousel to show current section centered
      const itemHeight = 40; // h-10 = 40px
      // Start at 40px offset, then move by itemHeight for each section
      const offset = 40 - (index * itemHeight);
      navCarousel.style.transform = `translateY(${offset}px)`;

      // Update styling for all items (both text and logo)
      const items = document.querySelectorAll('.nav-carousel-item');
      items.forEach((item, i) => {
        const textElement = item.querySelector('span');
        const logoElement = item.querySelector('img');

        if (i === index) {
          // Current item - prominent
          if (textElement) {
            textElement.classList.remove('text-xs', 'text-gray-400');
            textElement.classList.add('text-base', 'font-semibold', 'text-gray-900');
            textElement.style.opacity = '1';
          }
          if (logoElement) {
            logoElement.style.opacity = '1';
            logoElement.classList.remove('w-12', 'h-12');
            logoElement.classList.add('w-30', 'h-30');
          }
        } else if (i === index - 1 || i === index + 1) {
          // Adjacent items - smaller and faded
          if (textElement) {
            textElement.classList.remove('text-base', 'font-semibold', 'text-gray-900');
            textElement.classList.add('text-xs', 'text-gray-400');
            textElement.style.opacity = '0.6';
          }
          if (logoElement) {
            logoElement.style.opacity = '0.6';
            logoElement.classList.remove('w-30', 'h-30');
            logoElement.classList.add('w-12', 'h-12');
          }
        } else {
          // Far items - very faded
          if (textElement) {
            textElement.classList.remove('text-base', 'font-semibold', 'text-gray-900');
            textElement.classList.add('text-xs', 'text-gray-400');
            textElement.style.opacity = '0.3';
          }
          if (logoElement) {
            logoElement.style.opacity = '0.3';
            logoElement.classList.remove('w-30', 'h-30');
            logoElement.classList.add('w-12', 'h-12');
          }
        }
      });

      // Smoothly move active indicator in expanded view
      const activeIndicator = document.getElementById('active-indicator');
      const links = document.querySelectorAll('.nav-section-link');

      links.forEach((link, linkIndex) => {
        const sectionId = link.getAttribute('data-section');
        if (sectionId === current.id) {
          link.classList.add('text-indigo-600', 'font-semibold');

          // Move indicator to active link position
          if (activeIndicator) {
            const linkRect = link.getBoundingClientRect();
            const containerRect = link.parentElement.getBoundingClientRect();
            const offsetY = linkRect.top - containerRect.top;

            activeIndicator.style.transform = `translateY(${offsetY}px)`;
            activeIndicator.style.opacity = '1';
          }
        } else {
          link.classList.remove('text-indigo-600', 'font-semibold');
        }
      });
    }

    // Update current section based on scroll position
    function updateCurrentSection() {
      const viewportCenter = window.innerHeight / 2;
      let activeIndex = 0;
      let closestDistance = Infinity;

      // Find the section whose top is closest to (but above) viewport center
      for (let i = 0; i < sectionList.length; i++) {
        const element = document.getElementById(sectionList[i].id);
        if (!element) continue;

        const rect = element.getBoundingClientRect();
        const distanceFromCenter = viewportCenter - rect.top;

        // Only consider sections whose top has passed the viewport center
        if (rect.top <= viewportCenter) {
          // Pick the one closest to center (smallest positive distance)
          if (distanceFromCenter < closestDistance) {
            closestDistance = distanceFromCenter;
            activeIndex = i;
          }
        }
      }

      // Update display if section changed
      if (activeIndex !== currentSectionIndex) {
        updateSectionDisplay(activeIndex);
      }
    }

    // Update on scroll with throttling
    let scrollTimeout;
    window.addEventListener('scroll', () => {
      if (scrollTimeout) {
        cancelAnimationFrame(scrollTimeout);
      }
      scrollTimeout = requestAnimationFrame(updateCurrentSection);
    }, { passive: true });

    // Initial update
    updateCurrentSection();

    // Toggle on pill click
    navPill.addEventListener('click', toggleExpanded);

    // Navigate and collapse on section link click
    document.querySelectorAll('.nav-section-link').forEach(link => {
      link.addEventListener('click', (e) => {
        e.preventDefault();
        const targetId = link.getAttribute('href').substring(1);
        const targetElement = document.getElementById(targetId);

        if (targetElement) {
          targetElement.scrollIntoView({ behavior: 'smooth', block: 'start' });

          // Collapse after a short delay
          setTimeout(() => {
            if (isExpanded) {
              toggleExpanded();
            }
          }, 300);
        }
      });
    });

    // Click outside to collapse
    document.addEventListener('click', (e) => {
      if (isExpanded && !navExpanded.contains(e.target) && !navPill.contains(e.target)) {
        toggleExpanded();
      }
    });

    // Keyboard support (Escape to collapse)
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && isExpanded) {
        toggleExpanded();
        navPill.focus();
      }
    });

    // Don't force initialization - let Intersection Observer detect the visible section
    // This prevents wrong section showing on page load
  }

  // Initialize when DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initNavigator);
  } else {
    initNavigator();
  }
}
</script>

<style>
  .nav-pill {
    cursor: pointer;
    user-select: none;
  }

  #nav-expanded {
    animation: slideDown 0.2s ease-out;
  }

  @keyframes slideDown {
    from {
      opacity: 0;
      transform: translateY(-10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  /* Smooth text transitions */
  #nav-current, #nav-prev, #nav-next {
    transition: opacity 0.3s ease, transform 0.3s ease;
  }
</style>
