---
interface GalleryItem {
  url: string;
  width?: number;
  description?: string;
}

interface Props {
  images: GalleryItem[];
}

const { images } = Astro.props;
---

{images && images.length > 0 && (
  <div>
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
      {images.map((item, index) => (
        <button
          type="button"
          class="relative aspect-video rounded-lg overflow-hidden group shadow-lg hover:shadow-2xl transition-all duration-300 cursor-pointer"
          data-gallery-image={index}
        >
          <img
            src={item.url}
            alt={item.description || `Gallery image ${index + 1}`}
            class="w-full h-full object-cover transition-transform duration-300 group-hover:scale-105"
            loading="lazy"
          />
          <div class="absolute inset-0 bg-black/0 group-hover:bg-black/10 transition-colors duration-300 flex items-center justify-center">
            <svg class="w-12 h-12 text-white opacity-0 group-hover:opacity-100 transition-opacity duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM10 7v3m0 0v3m0-3h3m-3 0H7"></path>
            </svg>
          </div>
          {item.description && (
            <div class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/90 to-transparent text-white p-4 translate-y-full group-hover:translate-y-0 transition-transform duration-300">
              <p class="text-sm font-medium">{item.description}</p>
            </div>
          )}
        </button>
      ))}
    </div>

    <!-- Lightbox Dialog -->
    <dialog id="gallery-lightbox" class="fixed inset-0 z-50 w-screen h-screen bg-black/95 backdrop-blur-sm p-0 m-0 max-w-none max-h-none">
      <div class="relative w-full h-full flex items-center justify-center">
        <!-- Close button -->
        <button
          type="button"
          id="lightbox-close"
          class="absolute top-4 right-4 z-10 w-12 h-12 rounded-full bg-white/10 hover:bg-white/20 backdrop-blur-md text-white transition-colors duration-200 flex items-center justify-center"
          aria-label="Close"
        >
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>

        <!-- Previous button -->
        <button
          type="button"
          id="lightbox-prev"
          class="absolute left-4 z-10 w-12 h-12 rounded-full bg-white/10 hover:bg-white/20 backdrop-blur-md text-white transition-colors duration-200 flex items-center justify-center"
          aria-label="Previous image"
        >
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
          </svg>
        </button>

        <!-- Next button -->
        <button
          type="button"
          id="lightbox-next"
          class="absolute right-4 z-10 w-12 h-12 rounded-full bg-white/10 hover:bg-white/20 backdrop-blur-md text-white transition-colors duration-200 flex items-center justify-center"
          aria-label="Next image"
        >
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
          </svg>
        </button>

        <!-- Image container -->
        <div class="max-w-7xl max-h-full w-full h-full flex items-center justify-center p-4">
          <img
            id="lightbox-image"
            src=""
            alt=""
            class="max-w-full max-h-full object-contain"
          />
        </div>

        <!-- Image description -->
        <div id="lightbox-description" class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/90 to-transparent text-white p-6 text-center">
          <p class="text-lg font-medium"></p>
        </div>

        <!-- Counter -->
        <div class="absolute top-4 left-4 z-10 px-4 py-2 rounded-full bg-white/10 backdrop-blur-md text-white text-sm font-medium">
          <span id="lightbox-counter"></span>
        </div>
      </div>
    </dialog>

    <script define:vars={{ images }}>
      let currentIndex = 0;
      const dialog = document.getElementById('gallery-lightbox');
      const lightboxImage = document.getElementById('lightbox-image');
      const lightboxDescription = document.getElementById('lightbox-description');
      const lightboxCounter = document.getElementById('lightbox-counter');
      const closeBtn = document.getElementById('lightbox-close');
      const prevBtn = document.getElementById('lightbox-prev');
      const nextBtn = document.getElementById('lightbox-next');

      function updateLightbox(index) {
        currentIndex = index;
        const image = images[index];
        lightboxImage.src = image.url;
        lightboxImage.alt = image.description || `Gallery image ${index + 1}`;

        if (image.description) {
          lightboxDescription.querySelector('p').textContent = image.description;
          lightboxDescription.style.display = 'block';
        } else {
          lightboxDescription.style.display = 'none';
        }

        lightboxCounter.textContent = `${index + 1} / ${images.length}`;

        // Update button states
        prevBtn.style.opacity = index === 0 ? '0.5' : '1';
        nextBtn.style.opacity = index === images.length - 1 ? '0.5' : '1';
      }

      // Open lightbox
      document.querySelectorAll('[data-gallery-image]').forEach((button) => {
        button.addEventListener('click', () => {
          const index = parseInt(button.getAttribute('data-gallery-image'));
          updateLightbox(index);
          dialog.showModal();
          document.body.style.overflow = 'hidden';
        });
      });

      // Close lightbox
      closeBtn.addEventListener('click', () => {
        dialog.close();
        document.body.style.overflow = '';
      });

      // Close on backdrop click
      dialog.addEventListener('click', (e) => {
        if (e.target === dialog) {
          dialog.close();
          document.body.style.overflow = '';
        }
      });

      // Previous image
      prevBtn.addEventListener('click', () => {
        if (currentIndex > 0) {
          updateLightbox(currentIndex - 1);
        }
      });

      // Next image
      nextBtn.addEventListener('click', () => {
        if (currentIndex < images.length - 1) {
          updateLightbox(currentIndex + 1);
        }
      });

      // Keyboard navigation
      document.addEventListener('keydown', (e) => {
        if (!dialog.open) return;

        if (e.key === 'Escape') {
          dialog.close();
          document.body.style.overflow = '';
        } else if (e.key === 'ArrowLeft' && currentIndex > 0) {
          updateLightbox(currentIndex - 1);
        } else if (e.key === 'ArrowRight' && currentIndex < images.length - 1) {
          updateLightbox(currentIndex + 1);
        }
      });

      // Touch swipe support
      let touchStartX = 0;
      let touchEndX = 0;

      dialog.addEventListener('touchstart', (e) => {
        touchStartX = e.changedTouches[0].screenX;
      });

      dialog.addEventListener('touchend', (e) => {
        touchEndX = e.changedTouches[0].screenX;
        handleSwipe();
      });

      function handleSwipe() {
        const swipeThreshold = 50;
        const diff = touchStartX - touchEndX;

        if (Math.abs(diff) > swipeThreshold) {
          if (diff > 0 && currentIndex < images.length - 1) {
            // Swipe left - next image
            updateLightbox(currentIndex + 1);
          } else if (diff < 0 && currentIndex > 0) {
            // Swipe right - previous image
            updateLightbox(currentIndex - 1);
          }
        }
      }
    </script>
  </div>
)}
