---
import { getCollection } from 'astro:content';
import BaseLayout from '../../layouts/BaseLayout.astro';
import LanguageSwitcher from '../../components/LanguageSwitcher.astro';
import HomeSection from '../../components/HomeSection.astro';
import ContentCard from '../../components/ContentCard.astro';

export async function getStaticPaths() {
  const pages = await getCollection('pages', ({ data }) => {
    // Only generate routes for home pages with published status
    return data.status === 'published' && data.type === 'home';
  });

  return pages.map(page => ({
    params: {
      lang: page.data.language,
    },
    props: { page },
  }));
}

const { page } = Astro.props;
const { Content } = await page.render();

// Get all published pages in current language
const allPages = await getCollection('pages', ({ data }) => {
  return data.status === 'published' && data.language === page.data.language;
});

// Get all section pages and sort by order field
// Exclude subsections (they render within their parent section)
const sections = allPages
  .filter(p => p.data.type === 'section' && p.data.page_type === 'landing' && !p.data.subcategory)
  .sort((a, b) => {
    const orderA = a.data.order ?? 999;
    const orderB = b.data.order ?? 999;
    if (orderA !== orderB) return orderA - orderB;
    return a.data.category.localeCompare(b.data.category);
  });

// Helper function to get detail items for a category
const getDetailItems = (category: string) =>
  allPages.filter(p => p.data.category === category && p.data.type === 'detail');

// Helper function to get subsections for a category
const getSubsections = (category: string) =>
  allPages
    .filter(p => p.data.category === category && p.data.page_type === 'landing' && p.data.subcategory)
    .sort((a, b) => {
      const orderA = a.data.order ?? 999;
      const orderB = b.data.order ?? 999;
      if (orderA !== orderB) return orderA - orderB;
      return (a.data.subcategory || '').localeCompare(b.data.subcategory || '');
    });

const isEstonian = page.data.language === 'et';
---

<BaseLayout
  title={page.data.title}
  description={page.data.description}
  language={page.data.language}
  isHomepage={true}
>
  <LanguageSwitcher
    slot="language-switcher"
    currentLang={page.data.language}
    currentSlug="index"
    translations={page.data.translated}
  />

  <!-- Hero Section -->
  <section
    id="hero"
    class="min-h-screen flex items-center justify-center relative bg-slate-900"
    style={page.data.hero_image ? `background-image: url('${page.data.hero_image}'); background-size: cover; background-position: center;` : ''}
  >
    {page.data.hero_image && (
      <div class="absolute inset-0 bg-gradient-to-b from-slate-900/60 to-slate-900/40"></div>
    )}
    <div class="relative z-10 max-w-4xl mx-auto px-4 py-16 text-center">
      <h1 class={`text-5xl md:text-7xl font-bold mb-6 ${page.data.hero_image ? 'text-white' : 'text-slate-900'}`}>
        {page.data.title}
      </h1>
      <p class={`text-xl md:text-2xl mb-8 ${page.data.hero_image ? 'text-white/90' : 'text-slate-600'}`}>
        {page.data.description}
      </p>
      <div class={`prose prose-lg mx-auto ${page.data.hero_image ? 'prose-invert' : 'prose-slate'}`}>
        <Content />
      </div>
    </div>
  </section>

  <!-- Dynamic Sections -->
  {sections.map(async (section, index) => {
    const detailItems = getDetailItems(section.data.category);
    const subsections = getSubsections(section.data.category);
    const hasSubsections = subsections.length > 0;

    // Render section markdown content
    const { Content: SectionContent } = await section.render();

    // Alternate background colors
    const background = index % 2 === 0 ? 'white' : 'slate';

    return (
      <HomeSection
        id={section.data.category}
        title={section.data.title}
        description={section.data.description}
        heroImage={section.data.hero_image}
        backgroundColor={section.data.background_color}
        background={background}
      >
        {/* Render section markdown content with light overlay for hero images */}
        {section.data.hero_image ? (
          <div class="relative -mx-4 px-4 py-6 mb-12">
            <div class="absolute inset-0 bg-white/40"></div>
            <div class="prose prose-lg max-w-none relative z-10 [text-shadow:_0_2px_8px_rgb(255_255_255_/_80%)]">
              <SectionContent />
            </div>
          </div>
        ) : (
          <div class="prose prose-lg max-w-none mb-12">
            <SectionContent />
          </div>
        )}

        {hasSubsections ? (
          // Render subsections (e.g., Suurtele, Noorele Publikule)
          <>
            {subsections.map(subsection => {
              const subsectionItems = detailItems.filter(p => p.data.subcategory === subsection.data.subcategory);
              return (
                <div
                  id={subsection.data.subcategory}
                  class="mb-16 rounded-lg p-8 relative"
                  style={subsection.data.hero_image ? `background-image: url('${subsection.data.hero_image}'); background-size: cover; background-position: center;` : ''}
                >
                  {subsection.data.hero_image && (
                    <div class="absolute inset-0 bg-gradient-to-b from-slate-900/70 to-slate-900/50 rounded-lg"></div>
                  )}
                  <div class="relative z-10">
                    <h3 class={`text-2xl font-semibold mb-6 ${subsection.data.hero_image ? 'text-white' : 'text-slate-800'}`}>
                      {subsection.data.title}
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                      {subsectionItems.map(item => (
                        <ContentCard
                          title={item.data.title}
                          description={item.data.description}
                          href={`/${page.data.language}/${item.data.category}/${item.id.replace(/^(en|et)\//, '').replace(/\.md$/, '')}`}
                          subcategory={subsection.data.title}
                        />
                      ))}
                    </div>
                  </div>
                </div>
              );
            })}
          </>
        ) : (
          // Render regular detail items in grid
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
            {detailItems.map(item => (
              <ContentCard
                title={item.data.title}
                description={item.data.description}
                href={`/${page.data.language}/${item.data.category}/${item.id.replace(/^(en|et)\//, '').replace(/\.md$/, '')}`}
              />
            ))}
          </div>
        )}
      </HomeSection>
    );
  })}
</BaseLayout>

<style>
  html {
    scroll-behavior: smooth;
  }
</style>
