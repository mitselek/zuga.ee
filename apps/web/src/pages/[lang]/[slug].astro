---
import { getCollection } from 'astro:content';
import BaseLayout from '../../layouts/BaseLayout.astro';
import LanguageSwitcher from '../../components/LanguageSwitcher.astro';
import PageHero from '../../components/PageHero.astro';
import PerformanceGallery from '../../components/PerformanceGallery.astro';
import VideoEmbed from '../../components/VideoEmbed.astro';
import PerformanceList from '../../components/PerformanceList.astro';

export async function getStaticPaths() {
  const allPages = await getCollection('pages', ({ data }) => {
    return data.status === 'published';
  });

  const paths = [];

  for (const page of allPages) {
    const slug = page.id.replace(/^(en|et)\//, '').replace(/\.md$/, '');

    // For detail pages, create redirect to new hierarchical URL
    if (page.data.type === 'detail') {
      paths.push({
        params: {
          lang: page.data.language,
          slug: slug,
        },
        props: {
          page,
          redirect: `/${page.data.language}/${page.data.category}/${slug}`,
        },
      });
    }
    // For section pages, render normally
    else if (page.data.type === 'section') {
      paths.push({
        params: {
          lang: page.data.language,
          slug: slug,
        },
        props: { page },
      });
    }
    // Skip home pages (handled by [lang]/index.astro)
  }

  return paths;
}

const { page, redirect } = Astro.props;

// If this is a detail page, redirect to new hierarchical URL
if (redirect) {
  return Astro.redirect(redirect, 301);
}

const { Content } = await page.render();
const currentSlug = page.id.replace(/^(en|et)\//, '').replace(/\.md$/, '');
---

<BaseLayout
  title={page.data.title}
  description={page.data.description}
  language={page.data.language}
>
  <LanguageSwitcher
    slot="language-switcher"
    currentLang={page.data.language}
    currentSlug={currentSlug}
    translations={page.data.translated}
  />

  <PageHero
    title={page.data.title}
    subtitle={page.data.description}
    type={page.data.type}
    imageUrl={page.data.hero_image}
  />

  <article class="prose prose-lg prose-slate max-w-4xl mx-auto mb-16">
    <Content />
  </article>

  {page.data.gallery && (
    <section class="mb-16">
      <h2 class="text-3xl font-bold mb-8 text-center" style="font-family: var(--font-heading); color: var(--color-primary);">
        {page.data.language === 'et' ? 'Galerii' : 'Gallery'}
      </h2>
      <PerformanceGallery items={page.data.gallery} />
    </section>
  )}

  {page.data.videos && (
    <section class="mb-16">
      <h2 class="text-3xl font-bold mb-8 text-center" style="font-family: var(--font-heading); color: var(--color-primary);">
        {page.data.language === 'et' ? 'Videod' : 'Videos'}
      </h2>
      <VideoEmbed videos={page.data.videos} />
    </section>
  )}

  <!-- Show list of related pages for category/index pages -->
  {(currentSlug.includes('etendused') || currentSlug.includes('workshopid')) && (
    <PerformanceList
      language={page.data.language}
      category={currentSlug}
      currentSlug={currentSlug}
    />
  )}
</BaseLayout>
