---
import { getCollection } from 'astro:content';
import BaseLayout from '../../../layouts/BaseLayout.astro';
import LanguageSwitcher from '../../../components/LanguageSwitcher.astro';
import PageHero from '../../../components/PageHero.astro';
import PerformanceGallery from '../../../components/PerformanceGallery.astro';
import VideoEmbed from '../../../components/VideoEmbed.astro';
import AudioEmbed from '../../../components/AudioEmbed.astro';
import PerformanceList from '../../../components/PerformanceList.astro';

export async function getStaticPaths() {
  const pages = await getCollection('pages', ({ data }) => {
    // Only generate routes for detail pages with published status
    return data.status === 'published' && data.type === 'detail';
  });

  return pages.map(page => {
    const slug = page.id.replace(/^(en|et)\//, '').replace(/\.md$/, '');

    return {
      params: {
        lang: page.data.language,
        category: page.data.category,
        slug: slug,
      },
      props: { page },
    };
  });
}

const { page } = Astro.props;
const { Content } = await page.render();
const currentSlug = page.id.replace(/^(en|et)\//, '').replace(/\.md$/, '');

// Section titles based on language
const sectionTitles = {
  audio: page.data.language === 'et' ? 'Helid' : 'Audio',
  gallery: page.data.language === 'et' ? 'Pildid' : 'Gallery',
  video: page.data.language === 'et' ? 'Videod' : 'Videos',
};
---

<BaseLayout
  title={page.data.title}
  description={page.data.description}
  language={page.data.language}
>
  <LanguageSwitcher
    slot="language-switcher"
    currentLang={page.data.language}
    currentSlug={currentSlug}
    translations={page.data.translated}
  />

  <PageHero
    title={page.data.title}
    subtitle={page.data.description}
    imageUrl={page.data.hero_image}
  />

  <article class="prose prose-lg prose-slate max-w-4xl mx-auto mb-16">
    <Content />
  </article>

  {page.data.audio && page.data.audio.length > 0 && (
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 mb-16">
      <h2 class="text-3xl font-bold text-slate-900 mb-8">{sectionTitles.audio}</h2>
      <AudioEmbed audio={page.data.audio} />
    </div>
  )}

  {page.data.gallery && page.data.gallery.length > 0 && (
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 mb-16">
      <h2 class="text-3xl font-bold text-slate-900 mb-8">{sectionTitles.gallery}</h2>
      <PerformanceGallery images={page.data.gallery} />
    </div>
  )}

  {page.data.videos && page.data.videos.length > 0 && (
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 mb-16">
      <h2 class="text-3xl font-bold text-slate-900 mb-8">{sectionTitles.video}</h2>
      <VideoEmbed videos={page.data.videos} />
    </div>
  )}
</BaseLayout>
