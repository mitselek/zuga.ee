# Content Schema Definition

**Version**: 1.0  
**Date**: December 8, 2025  
**Author**: Morgan (Business Analyst)  
**Status**: Ready for Implementation

---

## Overview

This document defines the type-safe content schema for Astro Content Collections, based on analysis of 35 existing markdown files in `source_zuga_ee/pages/`.

---

## Astro Content Collection Configuration

### File: `apps/web/src/content/config.ts`

```typescript
import { z, defineCollection } from "astro:content";

/**
 * Pages collection schema
 *
 * Validates all markdown files in src/content/pages/
 * Based on frontmatter structure from source_zuga_ee/pages/
 *
 * Constitutional Compliance: §1 Type Safety First
 */
const pagesCollection = defineCollection({
  type: "content",
  schema: z.object({
    // Required fields
    title: z.string().min(1, "Title is required"),
    slug: z
      .string()
      .min(1, "Slug is required")
      .regex(
        /^[a-z0-9-]+$/,
        "Slug must be lowercase, alphanumeric with hyphens"
      ),
    language: z.enum(["en", "et"], {
      errorMap: () => ({ message: 'Language must be "en" or "et"' }),
    }),
    type: z.enum(
      ["performance", "about", "workshop", "news", "gallery", "contact"],
      {
        errorMap: () => ({ message: "Invalid page type" }),
      }
    ),
    status: z.enum(["published", "draft"], {
      errorMap: () => ({ message: 'Status must be "published" or "draft"' }),
    }),

    // Optional metadata fields
    description: z.string().optional(),
    page_type: z.string().optional(), // Legacy field, preserved for reference
    original_url: z.string().url().optional(),

    // Media fields
    hero_image: z.string().optional(),
    gallery: z
      .array(
        z.object({
          url: z.string(),
          width: z.number().positive().optional(),
          description: z.string().optional(),
        })
      )
      .optional(),
    videos: z
      .array(
        z.object({
          platform: z.enum(["youtube", "vimeo"]),
          video_id: z.string().min(1),
          title: z.string().optional(),
          url: z.string().url(),
        })
      )
      .optional(),

    // Bilingual linking
    translated: z
      .array(
        z.object({
          language: z.string(),
          slug: z.string(),
        })
      )
      .optional(),
  }),
});

export const collections = {
  pages: pagesCollection,
};
```

---

## TypeScript Types (Generated by Astro)

After defining the schema, Astro automatically generates TypeScript types:

```typescript
// Auto-generated: .astro/types.d.ts
declare module "astro:content" {
  export interface CollectionEntry<C extends keyof typeof collections> {
    id: string;
    slug: string;
    body: string;
    collection: C;
    data: InferEntrySchema<C>;
    render(): Promise<{
      Content: AstroComponent;
      headings: { depth: number; slug: string; text: string }[];
      remarkPluginFrontmatter: Record<string, any>;
    }>;
  }

  export function getCollection<C extends keyof typeof collections>(
    collection: C,
    filter?: (entry: CollectionEntry<C>) => boolean
  ): Promise<CollectionEntry<C>[]>;

  export function getEntry<C extends keyof typeof collections>(
    collection: C,
    id: string
  ): Promise<CollectionEntry<C>>;
}
```

---

## Field Reference

### Required Fields

| Field      | Type                     | Description                                       | Example           |
| ---------- | ------------------------ | ------------------------------------------------- | ----------------- |
| `title`    | `string`                 | Page title (displayed in headings, meta tags)     | `"Shame"`         |
| `slug`     | `string`                 | URL-friendly identifier (lowercase, hyphens only) | `"english-shame"` |
| `language` | `"en" \| "et"`           | Content language (ISO 639-1 code)                 | `"en"`            |
| `type`     | `enum`                   | Page type (affects template selection)            | `"performance"`   |
| `status`   | `"published" \| "draft"` | Publication status (drafts excluded from build)   | `"published"`     |

### Optional Metadata

| Field          | Type      | Description                                                              | Example                             |
| -------------- | --------- | ------------------------------------------------------------------------ | ----------------------------------- |
| `description`  | `string?` | Meta description for SEO (recommended 150-160 chars)                     | `"A powerful performance about..."` |
| `page_type`    | `string?` | **Legacy field** from original extraction (preserved for reference)      | `"about-us"`                        |
| `original_url` | `string?` | **Documentation field** - URL from original Google Sites (for reference) | `"https://sites.google.com/..."`    |

### Media Fields

| Field        | Type                  | Description                                   | Example                                   |
| ------------ | --------------------- | --------------------------------------------- | ----------------------------------------- |
| `hero_image` | `string?`             | Hero/header image URL (currently placeholder) | `"https://lh3.googleusercontent.com/..."` |
| `gallery`    | `Array<GalleryItem>?` | Image gallery items                           | See below                                 |
| `videos`     | `Array<VideoItem>?`   | Embedded video items                          | See below                                 |

#### `GalleryItem` Object

```typescript
{
  url: string;           // Image URL (currently placeholder)
  width?: number;        // Original width in pixels
  description?: string;  // Alt text / caption
}
```

**Example**:

```yaml
gallery:
  - url: https://lh3.googleusercontent.com/pw/...
    width: 1280
    description: Performance scene with three actors
```

#### `VideoItem` Object

```typescript
{
  platform: 'youtube' | 'vimeo';  // Video hosting platform
  video_id: string;               // Platform-specific video ID
  title?: string;                 // Video title (optional)
  url: string;                    // Full video URL
}
```

**Example**:

```yaml
videos:
  - platform: youtube
    video_id: qp22v58UQnw
    title: Shame - Performance Trailer
    url: https://www.youtube.com/watch?v=qp22v58UQnw
```

### Bilingual Linking

| Field        | Type                      | Description                               | Example   |
| ------------ | ------------------------- | ----------------------------------------- | --------- |
| `translated` | `Array<TranslationLink>?` | Links to translated versions of this page | See below |

#### `TranslationLink` Object

```typescript
{
  language: string; // Target language code
  slug: string; // Target page slug
}
```

**Example**:

```yaml
translated:
  - language: et
    slug: etendused-suurtele-habi
```

**Usage**: Powers language switcher component. If a page has no translation, switcher only shows current language.

---

## Page Type Templates

Different `type` values map to different Astro layouts:

| Type          | Template                  | Description                     | Example Pages                          |
| ------------- | ------------------------- | ------------------------------- | -------------------------------------- |
| `performance` | `PerformanceLayout.astro` | Theatrical performance showcase | `english-shame.md`, `english-noise.md` |
| `about`       | `AboutLayout.astro`       | About/team pages                | `english-about-us-1.md`                |
| `workshop`    | `WorkshopLayout.astro`    | Workshop/educational content    | (if any exist)                         |
| `news`        | `NewsLayout.astro`        | News/blog posts                 | (if any exist)                         |
| `gallery`     | `GalleryLayout.astro`     | Photo galleries                 | (if any exist)                         |
| `contact`     | `ContactLayout.astro`     | Contact information             | (if any exist)                         |

**Implementation Note**: Start with `PerformanceLayout` and `AboutLayout` (most common types). Add others as needed.

---

## Content Directory Structure

```text
apps/web/src/content/pages/
├── en/
│   ├── english-2-2-22.md
│   ├── english-about-us-1.md
│   ├── english-inthemood.md
│   ├── english-landing.md
│   ├── english-noise.md
│   ├── english-shame.md
│   ├── english-the-great-unknown.md
│   └── ... (9 total)
└── et/
    ├── etendused-lastele-karu-uus-kodu.md
    ├── etendused-lastele-lumivalguke-ja-seitse-pakapikku.md
    ├── etendused-suurtele-2-2-22.md
    ├── etendused-suurtele-habi.md
    ├── etendused-suurtele-helilooja.md
    └── ... (26 total)
```

**Total**: 35 markdown files (9 English + 26 Estonian)

---

## Validation Examples

### ✅ Valid Frontmatter

```yaml
---
title: Shame
slug: english-shame
language: en
type: performance
status: published
description: A powerful exploration of shame and vulnerability
hero_image: https://lh3.googleusercontent.com/pw/...
gallery:
  - url: https://lh3.googleusercontent.com/pw/...
    width: 1280
    description: Opening scene
  - url: https://lh3.googleusercontent.com/pw/...
    width: 1920
    description: Final tableau
videos:
  - platform: youtube
    video_id: qp22v58UQnw
    url: https://www.youtube.com/watch?v=qp22v58UQnw
translated:
  - language: et
    slug: etendused-suurtele-habi
---
# Shame

Performance content goes here...
```

### ❌ Invalid Frontmatter (Build Fails)

```yaml
---
title: "" # ❌ Empty string not allowed
slug: "English Shame" # ❌ Must be lowercase with hyphens
language: eng # ❌ Must be "en" or "et"
type: theater # ❌ Invalid type (not in enum)
status: active # ❌ Must be "published" or "draft"
gallery:
  - url: "not-a-url" # ❌ Invalid URL format
    width: -100 # ❌ Width must be positive
videos:
  - platform: dailymotion # ❌ Only youtube/vimeo supported
    video_id: "" # ❌ Empty video_id
    url: "invalid-url" # ❌ Invalid URL format
---
```

**Error Output**: Astro build will fail with detailed Zod validation errors pointing to the exact field and line number.

---

## Usage in Astro Pages

### Fetching Content

```typescript
// src/pages/[lang]/[...slug].astro
import { getCollection } from "astro:content";

// Get all published pages
const allPages = await getCollection("pages", ({ data }) => {
  return data.status === "published";
});

// Filter by language
const englishPages = allPages.filter((page) => page.data.language === "en");
const estonianPages = allPages.filter((page) => page.data.language === "et");

// Get specific page
const shamePage = allPages.find(
  (page) => page.data.slug === "english-shame" && page.data.language === "en"
);
```

### Generating Routes

```typescript
export async function getStaticPaths() {
  const pages = await getCollection("pages", ({ data }) => {
    return data.status === "published";
  });

  return pages.map((page) => ({
    params: {
      lang: page.data.language,
      slug: page.data.slug,
    },
    props: { page },
  }));
}
```

### Rendering Content

```astro
---
const { page } = Astro.props;
const { Content } = await page.render();
---

<html lang={page.data.language}>
  <head>
    <title>{page.data.title} | Zuga Theatre</title>
    <meta name="description" content={page.data.description || ''} />
  </head>
  <body>
    <h1>{page.data.title}</h1>
    <Content />

    {page.data.gallery && (
      <Gallery items={page.data.gallery} />
    )}

    {page.data.videos && page.data.videos.map(video => (
      <VideoEmbed {...video} />
    ))}
  </body>
</html>
```

---

## Migration Notes

### Copying Files from Source

When copying markdown files from `source_zuga_ee/pages/` to `apps/web/src/content/pages/`:

1. **Preserve directory structure**: `en/` and `et/` folders
2. **Keep filenames unchanged**: Maintains consistency with Git history
3. **Validate after copy**: Run `npm run build` to catch any schema violations
4. **Fix validation errors**: Update frontmatter to match schema (most should pass)

### Common Migration Issues

| Issue                              | Fix                                      |
| ---------------------------------- | ---------------------------------------- |
| Empty `title` or `slug`            | Add missing values                       |
| Invalid `language` (e.g., `"eng"`) | Change to `"en"` or `"et"`               |
| Missing `type` field               | Add appropriate type based on content    |
| Missing `status` field             | Add `status: published`                  |
| Invalid video platform             | Change to `youtube` or `vimeo`           |
| Malformed gallery URLs             | Keep original URL (will use placeholder) |

---

## Testing Strategy

### Build-Time Validation

```bash
# Validate schema (fails on any invalid frontmatter)
npm run build

# Expected output:
# ✓ Content collection 'pages' validated: 35 entries
# ✓ Build completed in 12s
```

### Runtime Validation (Optional)

For additional safety in development:

```typescript
// src/utils/validatePage.ts
import type { CollectionEntry } from "astro:content";

export function validatePage(page: CollectionEntry<"pages">): boolean {
  // Additional runtime checks beyond schema
  if (page.data.type === "performance" && !page.data.hero_image) {
    console.warn(`Performance page "${page.data.slug}" missing hero_image`);
  }

  if (page.data.gallery && page.data.gallery.length === 0) {
    console.warn(`Page "${page.data.slug}" has empty gallery array`);
  }

  return true;
}
```

---

## Future Schema Extensions (Phase 2+)

Potential fields for AI assistant integration:

```typescript
// Not included in Phase 1 schema
{
  author?: string;              // Content author (for multi-user editing)
  last_edited?: Date;           // Last edit timestamp
  ai_generated?: boolean;       // Flag for AI-generated content
  edit_history?: Array<Edit>;   // Version history
  seo_keywords?: string[];      // SEO keyword tracking
  featured?: boolean;           // Feature on homepage
}
```

**Decision**: Defer until Phase 2 requirements are clear (§5 Pragmatic Simplicity - YAGNI).

---

## Constitutional Compliance

### §1: Type Safety First ✅

- **Zod schemas** validate all frontmatter at build time
- **TypeScript strict mode** enforces type safety in components
- **Build fails** on any schema violation (no silent failures)
- **Auto-generated types** from Astro Content Collections

### §4: Observable Development ✅

- **Detailed error messages** from Zod (exact field, line number, validation rule)
- **Build logs** show validation progress (`35 entries validated`)
- **Clear documentation** of all fields and constraints

---

## References

- [Astro Content Collections Documentation](https://docs.astro.build/en/guides/content-collections/)
- [Zod Schema Validation](https://zod.dev/)
- [Constitution §1: Type Safety First](../../.specify/memory/constitution.md)
- [Phase 1 Architecture](./phase-1-architecture.md)

---

**Ready for Implementation**: Copy this schema definition into `apps/web/src/content/config.ts` after initializing Astro project.
